#!/usr/bin/env ruby

require 'ddreleaser'
require 'yaml'

pipeline_yaml = YAML.load_file(ARGV[0])

stages = []
pipeline_yaml['stages'].each do |stage_yaml|
  steps = []
  stage_yaml['steps'].each do |step_yaml|
    goal =
      if step_yaml['shell']
        DDReleaser::Goals::Shell.new(command: step_yaml['shell'])
      elsif step_yaml['gem_build']
        DDReleaser::Goals::GemBuilt.new(gemspec_file_path: step_yaml['gem_build'])
      elsif step_yaml['gem_push']
        DDReleaser::Goals::GemPushed.new(
          gem_file_path: step_yaml['gem_push']['gem_file_path'],
          gem_name: step_yaml['gem_push']['gem_name'],
          authorization: step_yaml['gem_push']['authorization'],
        )
      else
        raise 'Unknown step'
      end

    steps << DDReleaser::Step.new(step_yaml['name'], goal)
  end
  stages << DDReleaser::Stage.new(stage_yaml['name'], steps)
end

DDReleaser::Runner.new(stages).run
